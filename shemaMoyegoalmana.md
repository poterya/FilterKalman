
┌─────────────────────────────────────────────────────────────────┐
│                        СТАРТ СИСТЕМЫ                            │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │  Инициализация фильтра Калмана│
         │  x₀ = [1, 1, 1, 1]            │
         │  P₀ = 0.1·I, Q = 0.005·I      │
         └───────────────┬───────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │    КАЛИБРОВКА (2 секунды)     │
         │  Собрать 20 измерений гироскопа│
         │  ω₁, ω₂, ..., ω₂₀              │
         └───────────────┬───────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │  Вычислить baseline:          │
         │  ω_baseline = mean(ω_lpf)     │
         │  (низкочастотный фильтр)      │
         └───────────────┬───────────────┘
                         │
                         ▼
    ┌────────────────────────────────────────────┐
    │         ОСНОВНОЙ ЦИКЛ (50 Гц)              │
    └────────────────────┬───────────────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │  Получить данные гироскопа:   │
         │  ω_current = [ωₓ, ωᵧ, ωz]     │
         └───────────────┬───────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │  Низкочастотная фильтрация:   │
         │  ω_lpf = 0.2·ω + 0.8·ω_prev   │
         └───────────────┬───────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │  Вычислить ошибку:            │
         │  e = ω_lpf - ω_baseline       │
         │  e = [eₓ, eᵧ, ez]             │
         └───────────────┬───────────────┘
                         │
                         ├───────────────────────────────┐
                         │                               │
                         ▼                               ▼
    ┌────────────────────────────┐      ┌────────────────────────────┐
    │   ФИЛЬТР КАЛМАНА           │      │   ПАТТЕРН-ДЕТЕКЦИЯ         │
    ├────────────────────────────┤      ├────────────────────────────┤
    │ 1. Предсказание:           │      │ 1. Нормализация:           │
    │    x̂⁻ = x̂ₖ₋₁               │      │    e_norm = e/||e||        │
    │    P⁻ = Pₖ₋₁ + Q            │      │                            │
    │                            │      │ 2. Сравнение с паттернами: │
    │ 2. Вычислить H:            │      │    FR: [+1, -1, +1]        │
    │    H = [-0.3, +0.3, ...]   │      │    FL: [-1, -1, -1]        │
    │    (3×4 матрица)           │      │    RR: [+1, +1, -1]        │
    │                            │      │    RL: [-1, +1, +1]        │
    │ 3. Коррекция:              │      │                            │
    │    K = P⁻·Hᵀ·(H·P⁻·Hᵀ+R)⁻¹ │      │ 3. Скалярное произведение: │
    │    x̂ = x̂⁻ + K·(e - H·x̂⁻)   │      │    scoreᵢ = e_norm·patternᵢ│
    │    P = (I - K·H)·P⁻         │      │                            │
    │                            │      │ 4. Накопление истории:     │
    │ 4. Ограничение:            │      │    (окно 2 секунды)        │
    │    x̂ = clip(x̂, 0, 1)       │      │    votes[i] += scoreᵢ      │
    │                            │      │                            │
    │ → Эффективность винтов:    │      │ → Лучший кандидат:         │
    │   η = [η₀, η₁, η₂, η₃]     │      │   i = argmax(votes)        │
    └────────────┬───────────────┘      └────────────┬───────────────┘
                 │                                   │
                 └────────────┬──────────────────────┘
                              │
                              ▼
         ┌────────────────────────────────────┐
         │      ЛОГИКА ДЕТЕКЦИИ               │
         ├────────────────────────────────────┤
         │  i = argmax(gyro_scores)           │
         │  max_score = gyro_scores[i]        │
         │                                    │
         │  ЕСЛИ max_score > 0.4:             │
         │    ЕСЛИ ηᵢ < 0.85 ИЛИ              │
         │         max_score > 0.7:           │
         │      ┌─────────────────────┐       │
         │      │ ВИНТ i ПОВРЕЖДЕН!   │       │
         │      │ Публикация аларма   │       │
         │      └─────────────────────┘       │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │  Публикация статуса (10 Гц):       │
         │  - Эффективность всех винтов       │
         │  - Флаги повреждений               │
         │  - Scores паттернов                │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │      Возврат к началу цикла        │
         └────────────────────────────────────┘
